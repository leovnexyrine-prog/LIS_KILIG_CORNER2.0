<script>
function makeLink(){
  const receiver = document.getElementById("receiver").value.trim() || "Recipient";
  const message  = document.getElementById("message").value.trim() || "(No message)";
  const flower   = document.getElementById("flower").value;

  const payload = encodeURIComponent(JSON.stringify({receiver,message,flower}));
  const url = window.location.origin + window.location.pathname + "?data=" + payload;

  document.getElementById("link").innerHTML =
    `<p>Share this link:</p><a href="${url}" target="_blank">${url}</a>`;
  document.getElementById("qr").innerHTML = "";
  new QRCode(document.getElementById("qr"), { text: url, width: 220, height: 220 });
}

// ---------- Game ----------
function startGame(data){
  const canvas=document.getElementById("gameCanvas");
  const ctx=canvas.getContext("2d");
  const flower=data.flower.split(" ")[0]; // emoji
  let birdY=canvas.height/2, birdVel=0;
  const gravity=0.45, jump=-8;
  const pillars=[];
  let score=0;
  const targetScore=5; // how many gaps to pass to win
  const birdColor="pink";
  let gameOver=false;
  let restartReady=false;

  document.addEventListener("keydown",()=>{if(!gameOver) birdVel=jump;});
  canvas.addEventListener("click",()=>{
      if(!gameOver) birdVel=jump;
      else if(restartReady) location.reload();
  });

  function addPillar(){
    const gap=170; // ðŸŒŸ bigger gap
    const topH=Math.random()*(canvas.height-gap-40)+20;
    pillars.push({x:canvas.width, top:topH, width:50});
  }

  function update(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Bird
    birdVel+=gravity;
    birdY+=birdVel;
    ctx.fillStyle=birdColor;
    ctx.beginPath();
    ctx.arc(60,birdY,15,0,Math.PI*2);
    ctx.fill();

    // Pillars
    if(Math.random()<0.02) addPillar();
    for(let i=pillars.length-1;i>=0;i--){
      const p=pillars[i];
      p.x-=1.8; // ðŸŒŸ slower speed
      ctx.font="24px serif";
      for(let y=0;y<p.top;y+=24) ctx.fillText(flower,p.x,y);
      for(let y=p.top+170;y<canvas.height;y+=24) ctx.fillText(flower,p.x,y);

      // collision
      if(60+15>p.x && 60-15<p.x+p.width){
        if(birdY-15<p.top || birdY+15>p.top+170) gameOver=true;
      }
      // score
      if(p.x+ p.width<60 && !p.scored){ score++; p.scored=true; }

      if(p.x<-p.width) pillars.splice(i,1);
    }

    // Ground/ceiling
    if(birdY+15>canvas.height || birdY-15<0) gameOver=true;

    // Score
    ctx.fillStyle="#d63384";
    ctx.font="20px Arial";
    ctx.fillText("Score: "+score,10,25);

    if(!gameOver){
      requestAnimationFrame(update);
    } else {
      if(score>=targetScore){
        showMessage(data);
      } else {
        ctx.fillText("Game Over! Tap to Restart",60,canvas.height/2);
        restartReady=true;
      }
    }
  }
  update();
}

function showMessage(data){
  document.getElementById("gameCanvas").style.display="none";
  document.getElementById("view").style.display="block";
  document.getElementById("viewName").innerText=data.receiver;
  document.getElementById("viewFlower").innerText=data.flower.split(" ")[0];
  document.getElementById("viewMsg").innerText=data.message;
}

// ---------- Entry ----------
(function(){
  const params = new URLSearchParams(window.location.search);
  if(params.has("data")){
    try {
      const obj = JSON.parse(decodeURIComponent(params.get("data")));
      document.getElementById("create").style.display="none";
      document.getElementById("gameCanvas").style.display="block";
      startGame(obj);
    } catch(e){ console.error("Invalid bouquet data"); }
  }
})();
</script>
